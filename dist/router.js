"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const express_1=require("express"),lodash_1=__importDefault(require("lodash")),moment_1=__importDefault(require("moment")),request_1=__importDefault(require("request")),hostParser_1=require("./helpers/hostParser"),mockRequestAssembler_1=require("./helpers/mockRequestAssembler"),queryParamsMatcher_1=require("./helpers/queryParamsMatcher"),queryParser_1=require("./helpers/queryParser");class Router{constructor({config:e,loggingFunction:t,port:s}){this.config={entities:{endpoints:[],projects:[]},result:{httpPort:3e3,httpsPort:3001}},this.endpointsParams=new Map,this.endpointsBody=new Map,this.endpointsResponse=new Map,this.sendLogForMockedRequest=(()=>{const e={type:0,message:"WARNING - Multiple mocked endpoints found",date:moment_1.default().format("YYYY/MM/DD HH:mm:ss"),matched:!0,isWarning:!0};this.logMessage(e)}),this.config=e,this.logMessage=t,this.port=s,this.router=express_1.Router(),this.mountRoutes()}getExpressRouter(){return this.router}mountRoutes(){const{endpoints:e,projects:t}=this.config.entities;lodash_1.default.forEach(e,e=>{if(e.enable){const s=t[e.projectId],o="/"+s.slug+e.path;this.register(e,s.slug),this.parseEndpointResponse(e,o),this.parseParamsEndpoint(e,o),this.parseBodyEndpoint(e,o)}}),this.router.use("/",(e,t,s)=>{this.handleMissedRoute(e,t)})}parseEndpointResponse(e,t){let s=e.method+t;e.request.params&&"?"!==e.request.params&&(s+=e.request.params),e.request.body&&!lodash_1.default.isEqual(e.request.body,{})&&(s+=JSON.stringify(e.request.body)),this.endpointsResponse.set(s,e.response)}parseParamsEndpoint(e,t){const s=this.endpointsParams.get(t),o=s&&s.length>0?s:[];o.push(e.request.params),this.endpointsParams.set(t,o)}parseBodyEndpoint(e,t){const s=this.endpointsBody.get(t),o=s&&s.length>0?s:[];o.push(e.request.body),this.endpointsBody.set(t,o)}getAppropriateListenerFunction(e){if("delete"===e)return this.router.delete.bind(this.router);if("get"===e)return this.router.get.bind(this.router);if("patch"===e)return this.router.patch.bind(this.router);if("post"===e)return this.router.post.bind(this.router);if("put"===e)return this.router.put.bind(this.router);throw new Error("[getAppropriateListenerFunction] Unexpected API method to listen for")}logRequest(e,t,s,o,r){const i={method:e.method,path:e.path,body:e.body,matched:t,protocol:e.protocol,host:e.hostname,date:moment_1.default().format("YYYY/MM/DD HH:mm:ss"),port:parseInt(this.port.toString(),10),query:e.query,type:s,statusCode:o,response:r};this.logMessage(i)}register(e,t=""){const s="/"+t+e.path,o=e.method.toLowerCase();this.getAppropriateListenerFunction(o)(s,(t,o)=>{const r=s.includes("*")?this.getResponseBodyByParams(s,t):this.getResponseBodyByParams(t.path,t);if(r){const s={requestObject:t,responseObject:o,statusCode:e.statusCode||200,timeout:e.timeout||0,responseBody:r};this.sendResponse(s)}else this.handleMissedRoute(t,o)})}getResponseBodyByParams(e,t){if(t.query&&!lodash_1.default.isEmpty(t.query)){return this.paramsExists(this.endpointsParams.get(e),t)?this.endpointsResponse.get(t.method+e+this.parseQueryToString(t.query)):void 0}if(t.body&&!lodash_1.default.isEmpty(t.body)){const s=t.body.toString("utf8");return this.bodyExists(this.endpointsBody.get(e),s)?this.isJsonString(s)?this.endpointsResponse.get(t.method+e+JSON.stringify(JSON.parse(s))):this.endpointsResponse.get(t.method+e+`"${s}"`):void 0}return this.endpointsResponse.get(t.method+e)}sendResponse(e){const{responseObject:t,requestObject:s,statusCode:o,timeout:r,responseBody:i}=e;r>0?setTimeout(()=>t.status(o).send(i),r):t.status(o).send(i),this.logRequest(s,!0,1,e.statusCode)}isJsonString(e){try{JSON.parse(e)}catch(e){return!1}return!0}bodyExists(e,t){let s=!1;return e.forEach(e=>{this.isJsonString(t)?lodash_1.default.isEqual(t,{})&&lodash_1.default.isEqual(e,t)?s=!0:lodash_1.default.isEqual(e,JSON.parse(t))&&(s=!0):lodash_1.default.isEqual(e,t)&&(s=!0)}),s}paramsExists(e,t){let s=!1;return e&&e.forEach(e=>{lodash_1.default.isEqual(queryParser_1.parseQuery(e),t.query)&&(s=!0)}),s}parseQueryToString(e){const t=Object.keys(e);return 0===t.length?"":"?"+t.reduce((t,s)=>(t.push(s+"="+encodeURIComponent(e[s])),t),[]).join("&")}handleMissedRoute(e,t){const s=e.originalUrl.split("/")[1],o=lodash_1.default.find(this.config.entities.projects,e=>e.slug===s),{endpoints:r}=this.config.entities,{projects:i}=this.config.entities,n=queryParamsMatcher_1.getMockedEndpointForQuery(i,r,e);if(o&&o.urlPrefix&&0===n.length)this.forwardRequest(e,t);else if(n.length>0){const o=n[0];n.length>1&&this.sendLogForMockedRequest(),mockRequestAssembler_1.sendMockedRequest(e,t,s,o,this.port)}else this.logRequest(e,!1,2,404),t.status(404).send(o?"URL endpoint not found":`Project "${s}" not found`)}getForwardingOptions(e){const[,t,...s]=e.originalUrl.split("/"),o=lodash_1.default.find(this.config.entities.projects,e=>e.slug===t),{urlPrefix:r}=o,i=`${r}${r.endsWith("/")?"":"/"}${s.join("/")}`,n=hostParser_1.parseHost(i);return{headers:Object.assign(Object.assign({},e.headers),{host:n,"accept-encoding":""}),method:e.method,body:"GET"===e.method?null:e.body,uri:i,rejectUnauthorized:!1}}forwardRequest(e,t){const s=this.getForwardingOptions(e);request_1.default(s,(t,o,r)=>{const i=o.headers["content-encoding"];i&&i.includes("gzip")?this.forwardGzipRequest(s,e):t?this.logRequest(e,!1,3,0,t.toString()):this.logRequest(e,!0,2,o&&o.statusCode?o.statusCode:418,r.toString())}).pipe(t)}forwardGzipRequest(e,t){request_1.default(Object.assign(Object.assign({},e),{gzip:!0}),(e,s,o)=>{e?this.logRequest(t,!1,3,0,e.toString()):this.logRequest(t,!0,2,s&&s.statusCode?s.statusCode:418,o.toString())})}}exports.default=Router;